name: Analyze Notable Binaries

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - name: Build gobinsize
        run: go build -o gobinsize .
      
      - name: Build and analyze hugo (Linux)
        run: |
          echo "::group::Building hugo (Linux)"
          mkdir -p /tmp/binaries
          cd /tmp
          git clone --depth 1 https://github.com/gohugoio/hugo.git
          cd hugo
          GOOS=linux go build -o /tmp/binaries/hugo-linux
          echo "::endgroup::"
          
          echo "::group::Analyzing hugo (Linux)"
          $GITHUB_WORKSPACE/gobinsize /tmp/binaries/hugo-linux
          echo "::endgroup::"
      
      - name: Build and analyze hugo (Darwin)
        run: |
          echo "::group::Building hugo (Darwin)"
          cd /tmp/hugo
          GOOS=darwin go build -o /tmp/binaries/hugo-darwin
          echo "::endgroup::"
          
          echo "::group::Analyzing hugo (Darwin)"
          $GITHUB_WORKSPACE/gobinsize /tmp/binaries/hugo-darwin
          echo "::endgroup::"
      
      - name: Build and analyze terraform (Linux)
        run: |
          echo "::group::Building terraform (Linux)"
          cd /tmp
          git clone --depth 1 https://github.com/hashicorp/terraform.git
          cd terraform
          GOOS=linux go build -o /tmp/binaries/terraform-linux
          echo "::endgroup::"
          
          echo "::group::Analyzing terraform (Linux)"
          $GITHUB_WORKSPACE/gobinsize /tmp/binaries/terraform-linux
          echo "::endgroup::"
      
      - name: Build and analyze terraform (Darwin)
        run: |
          echo "::group::Building terraform (Darwin)"
          cd /tmp/terraform
          GOOS=darwin go build -o /tmp/binaries/terraform-darwin
          echo "::endgroup::"
          
          echo "::group::Analyzing terraform (Darwin)"
          $GITHUB_WORKSPACE/gobinsize /tmp/binaries/terraform-darwin
          echo "::endgroup::"
      
      - name: Build and analyze kubectl (Linux)
        run: |
          echo "::group::Building kubectl (Linux)"
          cd /tmp
          git clone --depth 1 https://github.com/kubernetes/kubernetes.git
          cd kubernetes
          make WHAT=cmd/kubectl
          cp _output/bin/kubectl /tmp/binaries/kubectl-linux
          echo "::endgroup::"
          
          echo "::group::Analyzing kubectl (Linux)"
          $GITHUB_WORKSPACE/gobinsize /tmp/binaries/kubectl-linux
          echo "::endgroup::"
      
      - name: Build and analyze kubectl (Darwin)
        run: |
          echo "::group::Building kubectl (Darwin)"
          cd /tmp/kubernetes
          GOOS=darwin go build -o /tmp/binaries/kubectl-darwin ./cmd/kubectl
          echo "::endgroup::"
          
          echo "::group::Analyzing kubectl (Darwin)"
          $GITHUB_WORKSPACE/gobinsize /tmp/binaries/kubectl-darwin
          echo "::endgroup::"
